---
title: "Histogram with median, interquartile range and outlier highlighting"
author: "Niek Van Wettere"
date: "2025-11-02"
categories: [visualization]
image: siguniang_mountain.jpg
format: 
  html:
    self-contained: true
    toc: true
    code-fold: false
    code-overflow: wrap
    df-print: paged
editor: source
---


In this blog post, we explore how a histogram plot can be enriched with information about median, interquartile range and outlier highlighting.

First, we load the tidyverse package.

```{r, message = F}

library('tidyverse', quietly = T)

```

<br />

Dummy data is generated: test scores for four different 'education levels'.

```{r}

set.seed(123)

n <- 1000
n_outliers <- 20  # number of outliers

# Generate test scores mostly around 50 with sd 15
test_scores <- rnorm(n, mean = 50, sd = 15)

# Clip values between 0 and 100
test_scores <- pmin(pmax(test_scores, 0), 100)

# Add some extreme outliers
outlier_indices <- sample(1:n, n_outliers)
test_scores[outlier_indices] <- sample(c(runif(n_outliers/2, 90, 100),  # high outliers
                                         runif(n_outliers/2, 0, 10)))   # low outliers

# Create education levels
education_levels <- sample(c("Level 1", "Level 2", "Level 3", "Level 4"), n, replace = TRUE)

# Combine into a dataframe
dataframe_with_test_scores <- data.frame(
  test_scores = test_scores,
  education_levels = education_levels
)


```


<br />


We calculate median and IQR-limits to plot along the histogram.

```{r}

summary_data_IQR <- dataframe_with_test_scores |>

  group_by(education_levels) |>

  summarise(

    number_of_students = n(),
    median_test_score = median(test_scores),
    IQR_lower = quantile(test_scores, 0.25),
    IQR_upper = quantile(test_scores, 0.75), .groups = 'drop') |>

  mutate(IQR_range = (IQR_upper - IQR_lower) |> round(2),

         outlier_threshold_1 = IQR_upper + (IQR_range * 1.5),
         outlier_threshold_2 = IQR_lower - (IQR_range * 1.5))

```

 

<br />

That information is joined with the original dataframe containing the test scores.

```{r}

test_scores_per_education_level_list <- dataframe_with_test_scores |>
  left_join(summary_data_IQR, by = join_by(education_levels))  |>
  group_split(education_levels) # Split in list of dataframes.

```

 

<br />

We create the histogram plots.

- The median value is shown as a green vertical line.
- The interquartile range is situated between the blue vertical lines.
- Outlier values are colored in red.

```{r}

list_plots <- vector(mode = "list", length = length(test_scores_per_education_level_list))

for (i in seq_along(test_scores_per_education_level_list))  { 

  # flexible bin-width
  max_value <- max(test_scores_per_education_level_list[[i]]$test_scores, na.rm = TRUE)
  binwidth <- max_value / 40 

  # median IQR-range
  median_coord <- test_scores_per_education_level_list[[i]]$median_test_score[1]
  median_label <- paste0(test_scores_per_education_level_list[[i]]$median_test_score[1] |> round(2), '%')
  IQR_upper_x_coord <- test_scores_per_education_level_list[[i]]$IQR_upper[1]
  IQR_range_label <- paste0('iqr: ', test_scores_per_education_level_list[[i]]$IQR_range[1], '%')

  # plot histogram
plot_result <- test_scores_per_education_level_list[[i]] |>
  mutate(color = ifelse(test_scores > outlier_threshold_1 | test_scores < outlier_threshold_2, "darkred", "grey")) |>

 
  ggplot(aes(x = test_scores, fill = color)) +

  facet_grid(cols = vars(education_levels), scales = 'fixed') +

  scale_x_continuous(breaks = scales::pretty_breaks(), labels = scales::percent_format(scale = 1), expand = expansion(mult = c(0, 0.05))) +

  scale_y_continuous(breaks = scales::pretty_breaks(), labels = scales::number_format(accuracy = 1)) +

  geom_histogram(binwidth = binwidth) +

  scale_fill_identity() +

geom_segment(aes(x = median_test_score, xend = median_test_score, y = 0, yend = Inf), color = "darkgreen", linewidth = 0.5, linetype = "dashed") +

  geom_segment(aes(x = IQR_lower, xend = IQR_lower, y = 0, yend = Inf), color = "blue", linewidth = 0.5, linetype = "dashed") +

  geom_segment(aes(x = IQR_upper, xend = IQR_upper, y = 0, yend = Inf), color = "blue", linewidth = 0.5, linetype = "dashed")  +

  labs(x = "test scores", y = "number of students") +

  theme_bw() +

  theme(axis.title.x = element_text(size = 10),  # Adjust x-axis title size

        axis.title.y = element_text(size = 10))   # Adjust y-axis title size


max_count_bin <- max(ggplot_build(plot_result)$data[[1]]$count)

# add text annotation for median and iqr-range
plot_result_with_annotation <- plot_result +

  annotate("text", x = IQR_upper_x_coord + (0.04 * max_value), y = 0.9 * max_count_bin, label = IQR_range_label, vjust = 1, hjust = 0, color = "blue", size = 3) +

annotate("text", x = median_coord, y = 0, label = median_label, vjust = 1.5, color = "darkgreen", size = 3) + expand_limits(y = - (max_count_bin * 0.1))


list_plots[[i]] <- plot_result_with_annotation

}

```


<br />

Now we visualize one plot from the list of plots that was created.

```{r}

list_plots[[1]]

```


<br />

The different graphs can also be combined in one panel.

```{r}

layout_matrix <- rbind(c(1, 2),

                       c(3, 4))

gridExtra::grid.arrange(grobs = list_plots, layout_matrix = layout_matrix, ncol = 2, top = "Distribution of test scores per education level")

```









